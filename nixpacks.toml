[phases.setup]
nixpkgsArchive = "23.05"
cmds = [
  "cp .env.example .env || echo 'No .env.example found'"
]

[phases.install]
cmds = [
  "apt-get update",
  "apt-get install -y supervisor nginx php-fpm",
  "composer install --no-dev --optimize-autoloader",
  "npm ci",
  "npm run build",
  "php artisan storage:link",
  "chmod -R 775 storage",
  "chmod -R 775 bootstrap/cache",
  "php artisan key:generate --force",
  "php artisan config:cache",
  "php artisan route:cache",
  "php artisan view:cache"
]

[phases.build]
cmds = [
  "echo 'Setting up Nginx configuration...'",
  "rm -f /etc/nginx/sites-enabled/default",
  "echo 'server { listen 80; root /app/public; index index.php; location / { try_files $uri $uri/ /index.php?$query_string; } location ~ \\.php$ { include snippets/fastcgi-php.conf; fastcgi_pass unix:/var/run/php/php-fpm.sock; } }' > /etc/nginx/sites-available/laravel.conf",
  "ln -s /etc/nginx/sites-available/laravel.conf /etc/nginx/sites-enabled/",
  "echo 'Build phase complete'"
]

[start]
cmd = "supervisord -c supervisord.conf"